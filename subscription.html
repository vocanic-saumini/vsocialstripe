<!DOCTYPE html>
<html>

<head>
	<meta charset="ISO-8859-1">
	<title>VSocial Stripe</title>
	
	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.debug.js"></script>
	
	<!-- Styles -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
	
	<style>
		#billing .row {
			margin: 5px;
		}
	</style>
</head>

<body>
	
	<script>
		$(document).ready(function() {
			var user = 'cus_AFWCpyPxnFJ2Dz';
			//var user = 'cus_AFnjZo2vfI8gRq';
			
			$('#subscriptionModal').on('click', '.subscribe', function(e) {
				var subscription	= $(this).data('subscription');
				var plan			= $(this).data('plan');
				
				$.post('api/updatesubscription.php', {
					subscription	: subscription,
		    		plan			: plan
		    	}, function(resp) {
		    		console.log(resp);
		    	});
			});
			
			$('#user_subscriptions').on('click', '.upgrade_subscription', function(e) {
				e.preventDefault();
				
				var currentPlan		= $(this).data('planid');
				var subscriptionId	= $(this).data('subscription');
				
				// Load all the plans
				$.getJSON('api/listplans.php', function(resp) {
					$('#subscription_plans').empty();
					
					// Loop through list and display plans
					for(var i = 0; i < resp.data.length; i++) {
						var template = $('#plan_template').html();
						
						template = template.replace(/__NAME__/g, resp.data[i]['name']);
						template = template.replace(/__PLAN__/g, resp.data[i]['id']);
						template = template.replace(/__AMOUNT_INDOLLARS__/g, resp.data[i]['amount'] / 100);
						template = template.replace(/__CURRENCY_CAPS__/g, resp.data[i]['currency'].toUpperCase());
						template = template.replace(/__TRIAL__/g, resp.data[i]['trial_period_days'] ? resp.data[i]['trial_period_days'] : 0);
						template = template.replace(/__SUBSCRIPTION__/g, subscriptionId);
						
						$('#subscription_plans').append(template);
					}
					
					$('#subscriptionModal').modal('show');
					
					$('#subscription_plans button[data-plan="'+currentPlan+'"]').prop('disabled', true);
				})
			});
			
			$('#user_invoices').on('click', '.inovice', function(e) {
				e.preventDefault();
				
				var invoiceData = $(this).data('invoice');
				
				// Retrieve customer data
				$.getJSON('api/customer.php?customer='+invoiceData.customer, function(resp) {
					var customer = resp;
					//console.log(customer);
					
					// Generate PDF
					var pdf = new jsPDF();
					
					pdf.setFontSize(10);
					pdf.text(moment.unix(invoiceData.date).format('MMMM Do YYYY'), 180, 25);
					pdf.text('INVOICE #' + invoiceData.receipt_number, 20, 35);
					pdf.text(invoiceData.total / 100 + ' ' + invoiceData.currency.toUpperCase(), 180, 50);
					
					pdf.text('Description', 20, 70);
					pdf.text('Unit', 100, 70);
					pdf.text('Price', 125, 70);
					pdf.text('Amount', 150, 70);
					// Invoice lines
					for(var i = 0; i < invoiceData.lines.data.length; i++) {
						var y = 70 + ((i + 1) * 10);
						
						pdf.text(invoiceData.lines.data[i].plan.name, 20, y);
						pdf.text('' + invoiceData.lines.data[i].quantity, 100, y);
						pdf.text('' + invoiceData.lines.data[i].plan.amount / 100, 125, y);
						pdf.text('' + invoiceData.lines.data[i].quantity * (invoiceData.lines.data[i].plan.amount / 100), 150, y);
					}
					
					var nextY = y + 20;
					
					pdf.text('SUBTOTAL', 20, nextY);
					pdf.text(''+invoiceData.subtotal / 100, 150, nextY);
					pdf.text('TOTAL', 20, nextY + 10);
					pdf.text(''+invoiceData.total / 100, 150, nextY + 10);
					
					pdf.save('Invoice.pdf');
				});
			});
			
			// Load all the subscriptions
			$.getJSON('api/subscription.php?customer='+user, function(resp) {
				
				// Loop through list and display
				for(var i = 0; i < resp.data.length; i++) {
					var template = $('#subscription_template').html();
					
					template = template.replace(/__SUBSCRIPTION__/g, resp.data[i]['id']);
					template = template.replace(/__PLAN_ID__/g, resp.data[i]['plan']['id']);
					template = template.replace(/__PLAN_NAME__/g, resp.data[i]['plan']['name']);
					template = template.replace(/__AMOUNT_INDOLLARS__/g, resp.data[i]['plan']['amount'] / 100);
					template = template.replace(/__CURRENCY_CAPS__/g, resp.data[i]['plan']['currency'].toUpperCase());
					template = template.replace(/__STATUS__/g, resp.data[i]['status'].toUpperCase());
					template = template.replace(/__FROM__/g, moment.unix(resp.data[i]['current_period_start']).format('MM/DD/YYYY'));
					template = template.replace(/__TO__/g, moment.unix(resp.data[i]['current_period_end']).format('MM/DD/YYYY'));
					
					$('#user_subscriptions').append(template);
				}
			});
			
			// Load all the invoices
			$.getJSON('api/invoice.php?customer='+user, function(resp) {
				
				// Loop through list and display
				for(var i = 0; i < resp.data.length; i++) {
					var template = '<tr>';
					
					template += '<td>' + moment.unix(resp.data[i]['date']).format('MM/DD/YYYY') + '</td>';
					template += '<td>' + resp.data[i]['currency'].toUpperCase() + ' ' + resp.data[i]['total'] / 100 + '</td>';
					template += '<td><button class="inovice btn btn-primary" data-invoice=\'' + JSON.stringify(resp.data[i]) + '\'><span class="glyphicon glyphicon-download"></span></button></td>';
					template += '</tr>';
					
					//console.log(resp.data[i]);
					
					$('#user_invoices').append(template);
				}
			});
			
			// Load billing details
			$.getJSON('api/customer.php?customer='+user, function(resp) {
				//console.log(resp);
				
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Name</label> : </div><div class="col-md-8">' + resp.sources.data[0].name + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Email</label> : </div><div class="col-md-8">' + resp.email + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Address 1</label> : </div><div class="col-md-8">' + resp.sources.data[0].address_line1 + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>City</label> : </div><div class="col-md-8">' + resp.sources.data[0].address_city + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Postal Code</label> : </div><div class="col-md-8">' + resp.sources.data[0].address_zip + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Country</label> : </div><div class="col-md-8">' + resp.sources.data[0].address_country + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Card</label> : </div><div class="col-md-8">' + resp.sources.data[0].brand + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Card Number</label> : </div><div class="col-md-8">XXXX-XXXX-XXXX-' + resp.sources.data[0].last4 + '</div></div>');
				$('#billing').append('<div class="row"><div class="col-md-4"><label>Expiry Date</label> : </div><div class="col-md-8">' + resp.sources.data[0].exp_month + '/' + resp.sources.data[0].exp_year + '</div></div>');
			});
		});
	</script>
	
	<div id="plan_template" style="display:none;">
		<div class="col-sm-6 col-md-4">
			<div class="thumbnail">
				<div class="caption">
					<h3>__NAME__</h3>
					
					<p>__AMOUNT_INDOLLARS__  __CURRENCY_CAPS__</p>
					<p>__TRIAL__ Days of trial</p>
					
					<button class="subscribe btn btn-primary" data-subscription="__SUBSCRIPTION__" data-plan="__PLAN__">Try now</button>
				</div>
			</div>
		</div>
	</div>
	
	<div id="subscription_template" style="display:none;">
		<div class="row" style="margin: 20px;">
			<h3>__PLAN_NAME__</h3>
			
			<p>__AMOUNT_INDOLLARS__  __CURRENCY_CAPS__</p>
			<p>From __FROM__ To __TO__</p>
			<p>__STATUS__</p>
			<a href="#" class="upgrade_subscription" data-planid="__PLAN_ID__" data-subscription="__SUBSCRIPTION__">Update Subscription</a>
		</div>
	</div>
	
	<div id="subscriptionModal" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Subscription Plans</h4>
				</div>
				
				<div id="subscription_plans" class="modal-body row">
					<!-- All the plans content comes here -->
					
				</div>
			</div>
		</div>
	</div>
	
	<div id="user_subscriptions" style="margin: 20px;">
		<h2 style="text-decoration: underline;">My Subscription</h2>
		<!-- All the user subscriptions comes here -->
	</div>
	
	<div style="margin: 20px;">
		<h2 style="text-decoration: underline;">My Invoices</h2>
		
		<table class="table table-striped">
			<thead>
				<tr>
					<th>Date</th>
					<th>Amount</th>
					<th>View</th>
				</tr>
			</thead>
			
			<tbody id="user_invoices">
				<!-- All the user invoices comes here -->
			</tbody>
		</table>
	</div>
	
	<div id="billing" style="margin: 20px;">
		<h2 style="text-decoration: underline;">Billing Details</h2>
		
		<!-- User billing details comes here -->
	</div>
	
</body>

</html>